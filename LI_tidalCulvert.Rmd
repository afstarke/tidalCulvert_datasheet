---
title: "Tidal Culvert Data QA-QC"
output: 
  rmdformats::html_clean:
    highlight: kate
---
** TOTAL WORK IN PROGRESS **

This attempts to both outline the current status of the tidal culvert data and provide a task list for walking through the data collected to date and the data that are yet to be collected. Sort of a hybrid documentation of methods and to-do list.

```{r knitr_init, echo=TRUE, message=FALSE, warning=FALSE, cache=FALSE}


## Global options
options(max.print="75")
opts_chunk$set(echo=FALSE,
	             cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
library(knitr)
library(rmdformats)

library(readr)
library(readxl)
library(tidyxl)
library(unpivotr)
library(tidyverse)
library(sf)
library(mapview)
library(rstudio)


# TODO: Move this code block to script and source in across multiple Rmds

library(readr)
library(readxl)
library(tidyxl)
library(unpivotr)
library(tidyverse)
library(sf)
library(mapview)
library(rstudio)
library(tncThemes)
library(plotly)
library(hrbrthemes)
library(leaflet)
library(knitr)

knitr::read_chunk("code/rmdSetup.R") # read code chunks from external files to extend beyond multiple Rmds.
```

```{r directorySetup, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
```

```{r spatialDataLoad, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
```

```{r culvertData, message=FALSE, paged.print=FALSE}
```


## Output 
Here's the output-- 
I added an option to the table so that a local version can be saved- It's a bit clumbsy here since it's so wide (lots of variables) but you can scroll left/right to see all the columns- or click 'Download' to save a copy to open in Excel.
 
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
DT::datatable(LIculvertData, rownames = FALSE, 
              extensions = 'Buttons', 
              options = list(
    dom = 'Bfrtip',
    buttons =
      list('copy', 'print', list(
        extend = 'collection',
        buttons = c('csv', 'excel', 'pdf'),
        text = 'Download'
      ))
  )
  )

xlsx::write.xlsx(LIculvertData, file = paste0(tidalCulvert_outputs, "/compiledTidalData.xlsx"))

```


## Missing Spatial Data by CrossingID
The following list contains filenames of datasheets that *DO NOT* have a corresponding location in shapefile (path: `r culvertPts_path `).  
Just a note that currently the only linkage between the field data sheets and the spatial data (the locations for culverts as derived from remotely sensed and groundtruthed data) are the CrossingID field. Care must be taken to ensure the names are entered correctly.  

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
DT::datatable(missingLIculverts, rownames = FALSE, 
              extensions = 'Buttons', 
              options = list(
    dom = 'Bfrtip',
    buttons =
      list('copy', 'print', list(
        extend = 'collection',
        buttons = c('csv', 'excel', 'pdf'),
        text = 'Download'
      ))
  )
  )



```


## Mapped Culverts
Out of the pile of datasheets in the folder _(`r tidalCulvert_datasheetsFolder`)_ this map shows locations that have a corresponding datasheet. 
The map below are locations (though some inaccuracies are evident...) of culverts with a related 'field datasheet' info. Click a point to see details. 

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

LIculvertData_location <- cleanLIculvert_GISpts %>% right_join(LIculvertData, by = "crossingID") # this object is picking up 2 extra joins- perhaps dupicate CrossingIDs?
map_assessedLItidalCulverts <- mapview(LIculvertData_location, zcol = "Assessed", cex = 4)
map_assessedLItidalCulverts

# TODO: Add that marsh complex priority shapefile that was used for the ebird work.
```

### Locations that have spatial data but no corredsponding data sheets. 

Color coded by 'Priority'.  
New data sheets will need to be made up for these locations (if they are to be assessed)


```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

map_missingsDataPts <- mapview(cleanLIculvert_GISpts %>% filter(!crossingID %in% LIculvertData$crossingID), 
                               zcol = 'Priority', 
                               cex = 4)

map_missingsDataPts

```

## Generating SUMMARIES for field and desktop assessments.
This section will walk through the process of merging the various bits and bobs from the Tidal Culvert Workbook assessments (spreadsheets), the GIS-derived location data (shapefile above), desktop assessments (data housed in the workbooks) and partner priorities (our priority marsh complexes as well) into a list/table of culvert assessment needs to help steer the field and desktop needs. This list can be merged or compared (or replaced eventually?...) with the 'MasterCrossingSpreadsheetChecklistEdit.xls' found here:`r tidalCulvert_outputs`.   
The resulting table will be updated regulalry and stored here: `r tidalCulvert_outputs`


```{r message=FALSE, warning=FALSE, paged.print=FALSE}

# unnest the tidyxl data to create summary of the field and desktop assessments. 
# TODO: Merge the Spatial data from Karen's shapefile and see what's missing what.
# TODO: use filePath as a link in either a DT::datatable or a xlsx file with embedded links (not sure this is doable in R). Needs to be relative path to work properly.
# TODO: List of tidied cells needed for summarizing on.
# Catchment/watershed attributes - cells D237:


LIculvertStatus <- LIculvertsAssessments %>% 
  select(filenames, lastChanges, filePath, decoded) %>% 
  unnest() %>% 
  select(filenames, lastChanges, filePath, dataName, values) %>%
  spread(key = dataName, value = values) %>% 
  select(filenames, crossingID, dateAssessed, observers, everything()) %>% # organize the order of the columns.
  rowwise() %>% 
  mutate(channelPoolWidths = sum(!is.na(c(ChannelWidth_upStream, 
                                          ChannelWidth_dwnStream, 
                                          maxPoolWidth_upStream, 
                                          maxPoolWidth_dwnStream)))/4,
         CatchmentAttributes = sum(!is.na(c(WatershedArea_upStream, 
                                            saltMarshArea, 
                                            WatershedLandCover_wetland, 
                                            WatershedLandCover_forested, 
                                            WatershedLandCover_impervious, 
                                            WatershedLandCover_developed)))/6,
         MarshMigrationPotential = sum(!is.na(c(marshMigrationPotential_acres, 
                                                marshMigrationPotential_evalUnit, 
                                                NWI_class_upStream, 
                                                NWI_class_dwnStream)))/4,
         fieldAssessed = ifelse(!is.na(dateAssessed), 'YES', 'NO'),
         DesktopComplete = ifelse(sum(channelPoolWidths, CatchmentAttributes, MarshMigrationPotential) == 3, "YES", "NO")) %>%
  select(filenames, lastChanges, crossingID, fieldAssessed, dateAssessed, observers, channelPoolWidths, CatchmentAttributes, MarshMigrationPotential, DesktopComplete)
 

  
DT::datatable(LIculvertStatus, rownames = FALSE, escape = FALSE,
              extensions = 'Buttons', 
              options = list(
    dom = 'Bfrtip',
    buttons =
      list('copy', 'print', list(
        extend = 'collection',
        buttons = c('csv', 'excel', 'pdf'),
        text = 'Download'
      ))
  )
  )


```



```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
# citations <- function(includeURL = TRUE, includeRStudio = TRUE) {
#     if(includeRStudio == TRUE) {
#         ref.rstudio <- RStudio.Version()$citation
#         if(includeURL == FALSE) {
#             ref.rstudio$url = NULL;
#         }
#         print(ref.rstudio, style = 'text')
#         cat('\n')
#     }
#
#     cit.list <- c('base', names(sessionInfo()$otherPkgs))
#     for(i in 1:length(cit.list)) {
#         ref <- citation(cit.list[i])
#         if(includeURL == FALSE) {
#             ref$url = NULL;
#         }
#         print(ref, style = 'text')
#         cat('\n')
#     }
# }
#
# citations()
```


### Recreating the embedded formulas:

To Do:
Unfold the Tidal Range Ratio formula N14 to determine reason for #/0Errors


```{r}


get.cell.formula <- function(tidysheet, cellOfInterest){
  
  val <- tidysheet %>% 
    filter(address == cellOfInterest) %>% 
    select(formula) %>% as.character() %>% 
    xlex()
  return(val)
  
}
# Use a mostly complete assessment form. 

LIculvertsAssessments %>% filter()

```




---
title: "Tidal Spreadsheet fun"
output: github_document

---

read in spreadsheet with tidyxl

```{r message=FALSE, warning=FALSE, paged.print=FALSE}

library(readr)
library(readxl)
library(tidyxl)
library(unpivotr)
library(tidyverse)

```

```{r}

# TODO Start with basic read in of spreadsheet and extracting the proper cells.
sheet <- "spreadsheets/Copy of Culvert37.xlsm" #IDEA perhaps build this as a shiny gadget to allow for pushing onto the web for others?


cells <- xlsx_cells(sheet) %>% 
  filter(is_blank == FALSE, sheet == "Data Sheet - SUMMARY") 
  
cells

```
There's a few issues (potential) that I've come across.  

* cells are merged which makes it hard to determine which cell actually contains the value of interest.  
* There are values that are selected using a formated control (like a dropdown) which can be very easily altered.  
  + accessing these values is best done through the *Data Sheet - SUMMARY* tab.  
* There appear to be cells with just spaces possibly? They are showing up as blank, but NOT empty. Unsure if this is an issue.


## Characters (aka Potential Keys):
Below (and in extractedKey.xlsx) are extracted *character* values with their associated cell address.  
**NOTE:** Some of these cells may in fact be data values and not keys.  

```{r}
characters <- cells[cells$data_type == "character", c("sheet", "address", "character")]

characters
```

## Numerics (aka Potential Values):
Similar to the characters above, these are assumed to be data values but could in fact be keys.  
```{r}
numerics <- cells[cells$data_type == "numeric", c("sheet", "address", "numeric")]

numerics
```

```{r}
# Careful here- this could overwrite work if a new file isn't created.
# xlsx::write.xlsx(characters, 
#                  file = "spreadsheets/extractedKey.xlsx", 
#                  sheetName = "Likely keys") 
# xlsx::write.xlsx(numerics, 
#                  file = "spreadsheets/extractedKey.xlsx", 
#                  sheetName = "Likely values", append = TRUE)

  
```

## Functions/Formulas:
Where are the formulas? And what do they do?

```{r}
formulas <- cells %>% filter(!is.na(formula)) %>% select(sheet, address, formula)

formulas %>% head(5)
```
Note that there are a fair number of formulas that simply reference a single cell from another sheet. An attempt at filtering these out
```{r}
#TODO: Confirm we're not filtering anything important out here accidently.
formulas %>% filter(!str_detect(formula, "Data"))


```


## Slice into these formulas
If we need to extract some values or explore what a formula is doing we can use xlex by passing the row of interest to the function.

Yikes! On a few of these...

```{r}

# Finding constants within formulas:
# directly from : https://nacnudus.github.io/tidyxl/articles/smells.html

tokens <-
  cells %>%
  filter(!is.na(formula)) %>%
  select(row, col, formula) %>%
  mutate(tokens = map(formula, xlex)) %>%
  select(-formula)

constants <- tokens %>% 
  unnest(tokens) %>% 
  filter(type %in% c("error", "bool", "number", "text"))

constants %>%
  count(token, sort = TRUE) %>%
  print(n = Inf)

```



## TO DOs:  
* Using a completed (and backed up) datasheet comb through the *spreadsheets/extractedKey_WORKING.xlsx* file to match data keys with data values.   

* **VERY IMPORTANT** work only in the 'extractedKey_WORKING' file. The other file will/can be overwritten.  

* Once this new master lookup/key is build here's the game plan.  
  + Create lookup in R using key-value pairs  built from the extractedKey file
  + within this lookup retain the 'expected keys' in a colum to act as an error catcher on data extractions later.  
* Need to extract lookup tables in Lookup tab to form joins to link data value with data description (7 = Riprap under the Wingwall Materials dropdown.)  


```{r}

# Helper function to look up values in a cell of interest.
# 

get.cell.value <- function(tidysheet, cellOfInterest){
  
  val <- tidysheet %>% 
    filter(address == cellOfInterest) %>% 
    # select(formula) %>% 
    # as.character()
    pull(formula)
  return(val)
  
}
#   
get.cell.value(cells, "AA65")


```




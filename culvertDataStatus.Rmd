---
title: "Tidal Culvert Data Status"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
    theme: spacelab
    source: embed
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
source("00_libraries.R")
knitr::read_chunk("code/rmdSetup.R") # read code chunks from external files to extend beyond multiple Rmds.
```

```{r directorySetup, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
```

```{r spatialDataLoad, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
```

```{r culvertData, message=FALSE, warning=FALSE, paged.print=FALSE}
```

Identifying Crossings {.storyboard}
=========================================

### Crossings Identified for assessment. These are _*ALL*_ points that have been flagged as potential tidal culverts. 


```{r allPtsMap, message=FALSE, warning=FALSE, paged.print=FALSE}
# Crossings that have been IDed via ArcMap and from partners.
# TODO: Tidal stations - check windy API
# TODO: Add popups and/or labels on hover. 

# NOTE -------
# This leaflet version was originally placed here for use with crosstalk. 
# basemap <- leaflet() %>% 
#   addProviderTiles(providers$CartoDB.Positron, group = "Carto DB") %>%
#   addProviderTiles(providers$HikeBike.HillShading, options = providerTileOptions(opacity = 0.3), group = "Carto DB") %>% 
#   addProviderTiles(providers$Esri.WorldImagery, group = "ESRI Aerials") %>% 
#   addMouseCoordinates(style = "basic") %>% 
#   addLayersControl(baseGroups = c("Carto DB", "ESRI Aerials"), overlayGroups = c("highlight"), position = "bottomright")
# 
# basemap %>% 
#   addCircleMarkers(data = LIculvert_GISpts, ~Longitude, ~Latitude, radius = 3, fillOpacity = 0.75, fillColor = as.character(tnc_color("Indigo")), stroke = FALSE) %>% 
#   addCircleMarkers(data = LIculvert_GISpts, ~Longitude, ~Latitude, radius = 4, fillOpacity = 1, fillColor = as.character(tnc_color("Red Rock")), stroke = FALSE, group = "highlight") %>% 
#   hideGroup("highlight")
#  

LIculvertMap <- mapview(LIculvertDataStatus_location, 
                               # zcol = 'Located', 
                               label = as.character(LIculvertDataStatus_location$crossingID), lwd = .5,
                               cex = 4, legend = TRUE, layer.name = "Identified Tidal Crossing")
LIculvertMap #+ marshMap


```

***  
The map to the left shows culverts that have been identified and started down the path of assessment. 
 
_*NOTE*_ that there's additional points that exist in the GIS file that had to be removed due to incorrect lat/lons these are listed below (might be blank if all have been fixed! (thanks Karen!).   

Currently there are _`r length((LIculvert_GISpts$crossingID))`_ mapped crossing locations of which _`r (length((LIculvert_GISpts$crossingID)) - length(unique(LIculvert_GISpts$crossingID)))`_ are duplicates.

The following crossing ID's are flagged as duplicate:
`r kable(duplicatePts)`

***

These are locations that have NO Tidal Crossing Assessment Workbooks associated with them _OR_ the crossing ID field in either the shapefile or the workbooks are non-matching. 

Are any of these areas of interest for assessing? The map currently uses the 'Priority Score' as size/color .  
The table below will can either be copied-pasted or downloaded as an excel file that can be used to reference which crossings need to have a data sheet made up (or perhaps not...). 




<!-- ```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE} -->
<!-- LIculvertDataStatus_location %>%  -->
<!--   st_set_geometry(NULL) %>%  -->
<!--   as.data.frame() %>%  -->
<!--   filter(is.na(filenames)) %>%  -->
<!--   dplyr::select(crossingID, ToBeAssessed_2019) %>%  -->
<!--   DT::datatable(rownames = FALSE,  -->
<!--               extensions = list('Buttons'),  -->
<!--               style="bootstrap", width="100%", -->
<!--               options = list(scrollY=300,  -->
<!--                              scroller=TRUE, -->
<!--                              dom = 'Bfrtip', -->
<!--                              buttons = list('copy', list(extend = 'collection', -->
<!--                                                          buttons = c('excel'), -->
<!--                                                          text = 'Download' -->
<!--                                                          )) -->
<!--                              ) -->
<!--               ) -->

<!-- ``` -->


### Potential Crossing Location QA
Put accessibility data here...


### Data Needs

Missing Locations 
These crossing IDs are missing corresponding GIS points (or are not named the same...).
Seems that some of these (20181 and 20182) were recently assessed and may have never originated in the GIS. Perhaps found in the field?

***
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
kable(missingLIculverts)

```

Prioritizing Field Assessments:
============================================================
Column {data-width=800}
------------------------------------------------------------
```{r}

LIculvertDataStatus_location %>% filter(FieldAssessmentComplete != "N") %>% 
  mutate(`Priority Crossing` = ifelse(ToBeAssessed_2019, "Yes", 'No')) %>% 
  mapview(zcol = "Priority Crossing", na.color = 'red', layer.name = "Priority")

# map_assessedLItidalCulverts <- mapview(LIculvertDataStatus_location %>% filter(FieldAssessmentComplete != "N"), ) 
 
# marshMap <- mapview(priorityMarshes, zcol = "WETLAND_TY", layer.name = "Wetland Type")

# map_assessedLItidalCulverts #+ marshMap

```

Columns {data-width=400}
--------------------------------------------------



Data Management/QA/Status
==================================================

```{r}
# Pivot Table

rpivotTable(LIculvertDataStatus_location, rows = c("ToBeAssessed_2019", "FieldAssessmentComplete"), 
            cols = "DesktopAssessmentComplete", width = "100%",
            rendererName = "Heatmap")

```


---
title: "Tidal Culvert Data Status"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
    theme: spacelab
    source: embed
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
source("00_libraries.R")
knitr::read_chunk("code/rmdSetup.R") # read code chunks from external files to extend beyond multiple Rmds.
```

```{r directorySetup, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
```

```{r spatialDataLoad, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
```

```{r culvertData, message=FALSE, warning=FALSE, paged.print=FALSE}
```

### Identifying Crossings

ALL Crossings Identified for assessment.
These are _*ALL*_ points that have been flagged as potential tidal culverts. 
*

```{r allPtsMap, message=FALSE, warning=FALSE, paged.print=FALSE}
# Crossings that have been IDed via ArcMap and from partners.
# TODO: Tidal stations - check windy API
# TODO: Add popups and/or labels on hover. 

# NOTE -------
# This leaflet version was originally placed here for use with crosstalk. 
# basemap <- leaflet() %>% 
#   addProviderTiles(providers$CartoDB.Positron, group = "Carto DB") %>%
#   addProviderTiles(providers$HikeBike.HillShading, options = providerTileOptions(opacity = 0.3), group = "Carto DB") %>% 
#   addProviderTiles(providers$Esri.WorldImagery, group = "ESRI Aerials") %>% 
#   addMouseCoordinates(style = "basic") %>% 
#   addLayersControl(baseGroups = c("Carto DB", "ESRI Aerials"), overlayGroups = c("highlight"), position = "bottomright")
# 
# basemap %>% 
#   addCircleMarkers(data = LIculvert_GISpts, ~Longitude, ~Latitude, radius = 3, fillOpacity = 0.75, fillColor = as.character(tnc_color("Indigo")), stroke = FALSE) %>% 
#   addCircleMarkers(data = LIculvert_GISpts, ~Longitude, ~Latitude, radius = 4, fillOpacity = 1, fillColor = as.character(tnc_color("Red Rock")), stroke = FALSE, group = "highlight") %>% 
#   hideGroup("highlight")
#  

LIculvertMap <- mapview(LIculvertDataStatus_location, 
                               zcol = 'FieldAssessmentComplete', 
                               label = as.character(LIculvertDataStatus_location$crossingID), lwd = .5,
                               cex = 4, legend = TRUE, layer.name = "Tidal Crossings:<br> ID'ed and Assessed")
LIculvertMap #+ marshMap


```

***  
The map to the left shows all the cuvlerts that have been identified and that are currently in the Long Island Culvert Mapping group on AGOL. These data also house the desktop data as extracted from the Workbooks in late September. The data are being updated direct to the AGOL dataset.

Crossings are colored by 'Status' 

***




### Data Needs

Missing Locations 
These crossing IDs are missing corresponding GIS points (or are not named the same...).
Seems that some of these (20181 and 20182) were recently assessed and may have never originated in the GIS. Perhaps found in the field?

***
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
kable(missingLIculverts)

```

### Prioritizing Field Assessments:  


```{r}

LIculvertDataStatus_location %>% filter(FieldAssessmentComplete != "N") %>% 
  mutate(`Priority Crossing` = ifelse(listedOnFieldSched, "Yes", 'No')) %>% 
  mapview(zcol = "Priority Crossing", na.color = 'red', layer.name = "Priority")

# map_assessedLItidalCulverts <- mapview(LIculvertDataStatus_location %>% filter(FieldAssessmentComplete != "N"), ) 
 
# marshMap <- mapview(priorityMarshes, zcol = "WETLAND_TY", layer.name = "Wetland Type")

# map_assessedLItidalCulverts #+ marshMap

```



### Data Management/QA/Status  


```{r}
# Pivot Table
LIculvertsAssessments %>% select(crossingID, heights) %>%  
  unnest() %>% mutate(hasHt = !is.na(Height)) -> hwi_qunat

rpivotTable(hwi_qunat, rows = c("Feature", "Position"), cols = "hasHt", rendererName = "Heatmap", aggregatorName = "Count as Fraction of Rows")

```

***
Proportion of crossings that have a measure for each feature and position (up/down stream)  

### Completeness by SITE

```{r}
# determine the missing HWI's 
LIculvertsAssessments %>% select(crossingID, heights) %>%  
  unnest() %>% mutate(hasHt = !is.na(Height)) -> hwi_qunat

rpivotTable(hwi_qunat, rows = c("Feature", "Position"), cols = "hasHt", rendererName = "Heatmap", aggregatorName = "Count as Fraction of Rows")

```


---
title: "Tidal Crossing Assessment and Priotization"
subtitle: "Suffolk County- Long Island"
output: html_notebook
---
 <script src= 'https://statics.teams.cdn.office.net/sdk/v1.5.2/js/MicrosoftTeams.min.js'></script>
 <script>
    microsoftTeams.initialize();
  </script>

### Intention
This document is meant to outline the workflow of the data used in the prioritization of the tidal crossings assessed under TNC's methods. These methods are applied to all the crossings uniformly. Summary sheet infomation, specific to an individual crossing, will be based on the output from this code. 

```{r priorizationFunctions, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# package setup and sourcing data etc.
source("functions/prioritization_functions.R")
source("00_libraries.R") # libraries used elsewhere and stored here for convienence
library(GGally)
theme_set(theme_ipsum())
options(digits = 2, scipen = 999)
```

### Starting Data source
Data extracted from Tidal Crossings Field workbooks using a suite of functions found in _/funcions/_.  To save memory and time a seperate script runs the extraction process and saves an output file (.rds) to the '/data' folder within this working directory. Call the datasets as needed here in the doc. Alternatively, running rdmSetup.R will source all functions and run updates on data if _'dataUpdate = '_ found near top of code chunk.

```{r data, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
LIculvertsAssessments <- readRDS("data/LIculvertsAssessments.rds")
LIculvertData_location <- read_rds("data/LIculvertData_location.rds")

LIculvertsAssessments %>% filter(crossingID != 71) %>% # FIXME: this crossing is a PIA needs review and fixing.
  select(crossingID, heights) %>% 
  unnest() %>% 
  unite(Feature, Position, col = "FP", sep = " ") %>% 
  select(crossingID, FP, adjustedHt) %>% 
  mutate(crossingID = as.numeric(crossingID)) %>% 
  spread(key = FP, value = adjustedHt) -> heights # heights are needed for some of the calculations. Perhaps a better method would be to use SQL-like queries referencing multiple tables as needed. 

LIculvertAssessmentData <- LIculvertData_location %>% left_join(heights) 
```

***
### Tidal Range Ratio  
Ratio of the upstream tidal range to downstream tidal range. Tidal range is estimated from difference in elevation from high water indicator and low tide eleveations at the time of the assessment. A ratio of 50% would indicate that the downstream tidal range is twice as large as the upstream tidal range.  


```{r tidalrange, message=FALSE, warning=FALSE, paged.print=TRUE}
LIculvertPrioritization <- LIculvertAssessmentData %>%
  mutate(tidalRangeRatio = tidal_range_ratio(us_hwi_stain = `HWI Wrack US`,
                                             ds_hwi_stain = `HWI Wrack DS`,
                                             us_low_tide_elevation = `Low Tide Water Elevation US`, 
                                             ds_low_tide_elevation = `Low Tide Water Elevation DS`),
         eval_TidalRangeSc = crit_tidal_range(tidalRangeRatio)) %>% 
  select(crossingID, `HWI Wrack US`, `Low Tide Water Elevation US`, `HWI Wrack DS`, `Low Tide Water Elevation DS`, tidalRangeRatio, eval_TidalRangeSc)

LIculvertPrioritization %>% st_drop_geometry() %>% arrange(tidalRangeRatio)

LIculvertPrioritization %>% st_drop_geometry() %>% select(-crossingID) %>% 
  ggpairs(title = "Tidal range ratio components correlations") + theme(strip.text.y = element_text(angle = 0))
# LIculvertPrioritization %>% ggplot(aes(x = tidalRangeRatio, y = NA, color = crossingID)) + geom_point() 
# plotly::ggplotly()

```


There are many sites that do not have enough data to calculate the tidal range ratios. 
**`r LIculvertPrioritization %>% filter(!is.na(tidalRangeRatio)) %>% nrow`** crossings have tidal range ratios calculated.

### Crossing Ratio
Crossing ratio is calculated from the greater of 2 ratios. The ratio of crossing structure to the stream section, for both the up and downstream sides. A wide rive with a small structure opening will score high, indicating a restriction.

```{r crossingratios, message=FALSE, warning=FALSE}
#IDEA: prefix all scoring variables with 'eval_'
# Workflow: Create a master tibble that will be added to with each code block. 
tmp <- LIculvertAssessmentData %>% st_drop_geometry() %>% 
  # Calculate the up and down stream crossing ratios
  mutate(crossingRatio_upStrm = crossing_ratio(channelWidth = da_ChannelWidth_upStream, 
                                               dimA = CrosDim_upA, 
                                               dimC = crossDim_upC),
    crossingRatio_dwStrm = crossing_ratio(channelWidth = da_ChannelWidth_dwnStream, 
                                          dimA = CrosDim_dwnA, 
                                          dimC = CrosDim_dwnC),
    crossingRatio = pmax(crossingRatio_dwStrm, crossingRatio_upStrm),
    # calculate the crossing ratio evaluation score.
    eval_crossingRatioSc = crit_crossing_ratio(crossing.ratio = crossingRatio)) %>% #NOTE: Must use pmax with dplyr! And must score for final prioritizations.
  select(crossingID, crossingRatio_upStrm, crossingRatio_dwStrm, crossingRatio, eval_crossingRatioSc)

tmp %>% arrange(eval_crossingRatioSc)

tmp %>% select(-crossingID) %>% 
  ggpairs(title = "Crossing ratio components correlations") + theme(strip.text.y = element_text(angle = 0))

# Like what we see? Join to the master LIculvertPrioritization tibbel.
LIculvertPrioritization <- LIculvertPrioritization %>% 
  left_join(tmp, by = "crossingID")

```

### Erosion Classification

The ratio of scour pool width to channel width for both up and down stream sections. A large ratio indicates a larger scour pool 

```{r erosionClass, message=FALSE, warning=FALSE}

tmp <- LIculvertAssessmentData %>% st_drop_geometry() %>% 
  # Calculate the up and down stream classification 'raw' scores
  mutate(erosionClass_upStrm = erosion_class(scour_pool = da_MaxPoolWidth_upStream, 
                                             channel_width = da_ChannelWidth_upStream),
         erosionClass_dwnStrm = erosion_class(scour_pool = da_MaxPoolWidth_dwnStream, 
                                              channel_width = da_ChannelWidth_dwnStream),
    crossingRatio = pmax(crossingRatio_dwStrm, crossingRatio_upStrm),
    # calculate the erosion classification evaluation score.
    eval_erosionClassSc = crit_erosion_class(us_eclass = erosionClass_upStrm, 
                                             ds_eclass = erosionClass_dwnStrm))
  select(crossingID, erosionClass_upStrm, erosionClass_dwnStrm, eval_erosionClassSc)

tmp %>% arrange(eval_crossingRatioSc)

tmp %>% select(-crossingID) %>% 
  ggpairs(title = "Crossing ratio components correlations") + theme(strip.text.y = element_text(angle = 0))

# Like what we see? Join to the master LIculvertPrioritization tibbel.
LIculvertPrioritization <- LIculvertPrioritization %>% 
  left_join(tmp, by = "crossingID")

```

